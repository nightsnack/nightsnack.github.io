<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nightsnack.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="Java HashMap æºç å­¦ä¹ ç¬”è®°">
<meta property="og:type" content="article">
<meta property="og:title" content="Java HashMap æºç å­¦ä¹ ç¬”è®°">
<meta property="og:url" content="https://nightsnack.github.io/2018/02/07/java-hashmap/index.html">
<meta property="og:site_name" content="Yuxuan Cai - Personal Blog">
<meta property="og:description" content="Java HashMap æºç å­¦ä¹ ç¬”è®°">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-02-07T08:16:49.000Z">
<meta property="article:modified_time" content="2022-12-27T06:31:57.426Z">
<meta property="article:author" content="Yuxuan Cai">
<meta property="article:tag" content="java">
<meta property="article:tag" content="javaæºç ">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://nightsnack.github.io/2018/02/07/java-hashmap/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>Java HashMap æºç å­¦ä¹ ç¬”è®° | Yuxuan Cai - Personal Blog</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Yuxuan Cai - Personal Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Yuxuan Cai</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fas fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-blog">

    <a href="/about/" rel="section"><i class="fa fa-blog fa-fw"></i>Blog</a>

  </li>
        <li class="menu-item menu-item-publications">

    <a href="/publications" rel="section"><i class="fas fa-book-open fa-fw"></i>Publications</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resume">

    <a href="/attaches/CV.pdf" rel="section"><i class="fas fa-file fa-fw"></i>Resume</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yuxuan Cai"
      src="/image/avatar.png">
  <p class="site-author-name" itemprop="name">Yuxuan Cai</p>
  <div class="site-description" itemprop="description">Publications and Resume</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/nightsnack" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;nightsnack" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:nightsnackc@gmail.com" title="E-Mail â†’ mailto:nightsnackc@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/yuxuan-cai-4a1833109" title="LinkedIn â†’ https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yuxuan-cai-4a1833109" rel="noopener" target="_blank"><i class="fab fa-linkedin-in fa-fw"></i>LinkedIn</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://dblp.org/pid/209/5515.html" title="dblp â†’ https:&#x2F;&#x2F;dblp.org&#x2F;pid&#x2F;209&#x2F;5515.html" rel="noopener" target="_blank"><i class="fas fa-file-code fa-fw"></i>dblp</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://scholar.google.com/citations?user=EzYiBeUAAAAJ&hl=en" title="Google Scholar â†’ https:&#x2F;&#x2F;scholar.google.com&#x2F;citations?user&#x3D;EzYiBeUAAAAJ&amp;hl&#x3D;en" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google Scholar</a>
      </span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/nightsnack" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://nightsnack.github.io/2018/02/07/java-hashmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/image/avatar.png">
      <meta itemprop="name" content="Yuxuan Cai">
      <meta itemprop="description" content="Publications and Resume">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuxuan Cai - Personal Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java HashMap æºç å­¦ä¹ ç¬”è®°
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-02-07 16:16:49" itemprop="dateCreated datePublished" datetime="2018-02-07T16:16:49+08:00">2018-02-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-12-27 14:31:57" itemprop="dateModified" datetime="2022-12-27T14:31:57+08:00">2022-12-27</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="java-hashmap-æºç å­¦ä¹ ç¬”è®°">Java HashMap æºç å­¦ä¹ ç¬”è®°</h2>
<a id="more"></a>
<p>mapå­ç±»ä¸­çš„hashmapï¼Œæºç å­¦ä¹ è®°å½•ã€‚éƒ¨åˆ†æ˜¯ç¿»è¯‘è¿˜æœ‰ä¸€äº›æ˜¯è‡ªå·±çš„è®°å½•ã€‚</p>
<p>å†™èµ·æ¥æ‰å‘ç°å¥½å‘å•Šï¼Œç½‘ä¸Šå¾ˆå¤šæ˜¯1.7çš„ï¼Œæˆ‘çœ‹çš„æ˜¯1.8çš„ï¼Œæ²¡æƒ³åˆ°1.7æ ¹1.8å·®çš„è¿˜æŒºå¤šçš„ã€‚1.7æºç éƒ½æ²¡çœ‹è¿‡çš„æˆ‘â€¦ğŸ™</p>
<h3 id="å¸¸é‡åˆå§‹åŒ–">1.å¸¸é‡åˆå§‹åŒ–</h3>
<p>The default initial capacity - MUST be a power of two.<br />
</p>
<p>æœ€å°åˆå§‹å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16 </span></span><br></pre></td></tr></table></figure>
<p>The maximum capacity, used if a higher value is implicitly specified
by either of the constructors with arguments. MUST be a power of two
&lt;= 1&lt;&lt;30.</p>
<p>æœ€å¤§å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚ï¼Œ<strong>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</strong>è§hashå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br></pre></td></tr></table></figure>
<p>The load factor used when none specified in constructor.</p>
<p>è´Ÿè½½å¹³è¡¡ï¼Œæ˜¯æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦çš„å¹³è¡¡ï¼Œoracleå®˜æ–¹ç»™å‡ºçš„æ˜¯0.75æ˜¯æœ€ä½³ã€‚è¿‡é«˜çš„å› å­ä¼šé™ä½å­˜å‚¨ç©ºé—´ä½†æ˜¯æŸ¥æ‰¾ï¼ˆlookupï¼ŒåŒ…æ‹¬HashMapä¸­çš„putä¸getæ–¹æ³•ï¼‰çš„æ—¶é—´å°±ä¼šå¢åŠ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure>
<p>The bin count threshold for using a tree rather than list for a bin.
Bins are converted to trees when adding an element to a bin with at
least this many nodes. The value must be greater than 2 and should be at
least 8 to mesh with assumptions in tree removal about conversion back
to plain bins upon shrinkage.</p>
<p>å½“èŠ‚ç‚¹ä¸ªæ•°&gt;= TREEIFY_THRESHOLD -
1æ—¶ï¼ŒHashMapå°†é‡‡ç”¨çº¢é»‘æ ‘å­˜å‚¨ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå½“å‘ç”ŸHashå†²çªæ—¶ï¼ŒHashMapé¦–å…ˆæ˜¯é‡‡ç”¨é“¾è¡¨å°†é‡å¤çš„å€¼ä¸²èµ·æ¥ï¼Œå¹¶å°†æœ€åæ”¾å…¥çš„å€¼ç½®äºé“¾é¦–ï¼Œjava8å¯¹HashMapè¿›è¡Œäº†ä¼˜åŒ–ã€‚å½“èŠ‚ç‚¹ä¸ªæ•°å¤šäº†ä¹‹åä½¿ç”¨çº¢é»‘æ ‘å­˜å‚¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œæœ€åçš„æƒ…å†µä¸‹å³æ‰€æœ‰çš„keyéƒ½Hashå†²çªï¼Œé‡‡ç”¨é“¾è¡¨çš„è¯æŸ¥æ‰¾æ—¶é—´ä¸ºO(n),è€Œé‡‡ç”¨çº¢é»‘æ ‘ä¸ºO(logn)ï¼Œè¿™ä¹Ÿæ˜¯Java8ä¸­HashMapæ€§èƒ½æå‡çš„å¥¥ç§˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">8</span>; </span><br></pre></td></tr></table></figure>
<p>The bin count threshold for untreeifying a (split) bin during a
resize operation. Should be less than TREEIFY_THRESHOLD, and at most 6
to mesh with shrinkage detection under removal.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNTREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>The smallest table capacity for which bins may be treeified.
(Otherwise the table is resized if too many nodes in a bin.) Should be
at least 4 * TREEIFY_THRESHOLD to avoid conflicts between resizing and
treeification thresholds.</p>
<p>é‡æ–°åˆ†é…å¤§å°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_TREEIFY_CAPACITY</span> <span class="operator">=</span> <span class="number">64</span>;</span><br></pre></td></tr></table></figure>
<p>HashMapæ€§èƒ½çš„æœ‰ä¸¤ä¸ªå‚æ•°ï¼šåˆå§‹å®¹é‡(initialCapacity)
å’ŒåŠ è½½å› å­(loadFactor)ã€‚å®¹é‡
æ˜¯å“ˆå¸Œè¡¨ä¸­æ¡¶çš„æ•°é‡ï¼Œåˆå§‹å®¹é‡åªæ˜¯å“ˆå¸Œè¡¨åœ¨åˆ›å»ºæ—¶çš„å®¹é‡ã€‚åŠ è½½å› å­
æ˜¯å“ˆå¸Œè¡¨åœ¨å…¶å®¹é‡è‡ªåŠ¨å¢åŠ ä¹‹å‰å¯ä»¥è¾¾åˆ°å¤šæ»¡çš„ä¸€ç§å°ºåº¦ã€‚å½“å“ˆå¸Œè¡¨ä¸­çš„æ¡ç›®æ•°è¶…å‡ºäº†åŠ è½½å› å­ä¸å½“å‰å®¹é‡çš„ä¹˜ç§¯æ—¶ï¼Œåˆ™è¦å¯¹è¯¥å“ˆå¸Œè¡¨è¿›è¡Œ
rehash æ“ä½œï¼ˆå³é‡å»ºå†…éƒ¨æ•°æ®ç»“æ„ï¼‰ï¼Œä»è€Œå“ˆå¸Œè¡¨å°†å…·æœ‰å¤§çº¦ä¸¤å€çš„æ¡¶æ•°ã€‚</p>
<h3 id="hashå‡½æ•°">2.Hashå‡½æ•°</h3>
<p>Computes key.hashCode() and spreads (XORs) higher bits of hash to
lower. Because the table uses power-of-two masking, sets of hashes that
vary only in bits above the current mask will always collide. (Among
known examples are sets of Float keys holding consecutive whole numbers
in small tables.) So we apply a transform that spreads the impact of
higher bits downward. There is a tradeoff between speed, utility, and
quality of bit-spreading. Because many common sets of hashes are already
reasonably distributed (so don't benefit from spreading), and because we
use trees to handle large sets of collisions in bins, we just XOR some
shifted bits in the cheapest possible way to reduce systematic lossage,
as well as to incorporate impact of the highest bits that would
otherwise never be used in index calculations because of table
bounds.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;   <span class="comment">//jdk1.8 &amp; jdk1.7</span></span><br><span class="line">     <span class="type">int</span> h;</span><br><span class="line">     <span class="comment">// h = key.hashCode() ä¸ºç¬¬ä¸€æ­¥ å–hashCodeå€¼</span></span><br><span class="line">     <span class="comment">// h ^ (h &gt;&gt;&gt; 16)  ä¸ºç¬¬äºŒæ­¥ é«˜ä½å‚ä¸è¿ç®—</span></span><br><span class="line">     <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">indexFor</span><span class="params">(<span class="type">int</span> h, <span class="type">int</span> length)</span> &#123;  <span class="comment">//jdk1.7çš„æºç ï¼Œjdk1.8æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å®ç°åŸç†ä¸€æ ·çš„</span></span><br><span class="line">     <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);  <span class="comment">//ç¬¬ä¸‰æ­¥ å–æ¨¡è¿ç®—</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åœ¨å“ˆå¸Œè¡¨å®¹é‡ï¼ˆä¹Ÿå°±æ˜¯bucketsæˆ–slotså¤§å°ï¼‰ä¸ºlengthçš„æƒ…å†µä¸‹ï¼Œä¸ºäº†ä½¿æ¯ä¸ªkeyéƒ½èƒ½åœ¨å†²çªæœ€å°çš„æƒ…å†µä¸‹æ˜ å°„åˆ°<code>[0,length)</code>ï¼ˆæ³¨æ„æ˜¯å·¦é—­å³å¼€åŒºé—´ï¼‰çš„ç´¢å¼•ï¼ˆindexï¼‰å†…ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§åšæ³•ï¼š</p>
<ol type="1">
<li>è®©lengthä¸ºç´ æ•°ï¼Œç„¶åç”¨<code>hashCode(key) mod length</code>çš„æ–¹æ³•å¾—åˆ°ç´¢å¼•</li>
<li>è®©lengthä¸º2çš„æŒ‡æ•°å€ï¼Œç„¶åç”¨<code>hashCode(key) &amp; (length-1)</code>çš„æ–¹æ³•å¾—åˆ°ç´¢å¼•</li>
</ol>
<p><a
target="_blank" rel="noopener" href="http://docs.oracle.com/javase/7/docs/api/index.html?java/util/Hashtable.html">HashTable</a>ç”¨çš„æ˜¯æ–¹æ³•1ï¼Œ<code>HashMap</code>ç”¨çš„æ˜¯æ–¹æ³•2ã€‚</p>
<p>ä¸‹å›¾ï¼Œnä¸ºå“ˆå¸Œåˆ—è¡¨é•¿åº¦</p>
<p><img
src="https://ws2.sinaimg.cn/large/006tKfTcgy1fo6yr3pfc8j30xa0j0q5u.jpg" /></p>
<p>ä¹Ÿå°±æ˜¯é«˜16ä½ä¸ä½16ä½XORï¼ˆå…¶å®æ˜¯åŸå€¼å’Œé«˜16ä½å³ç§»16ä½åçš„å€¼XORï¼‰åå†å’Œ
length-1 &amp;è¿ç®—ï¼Œlengthæ˜¯2
çš„æŒ‡æ•°æ¬¡å¹‚ï¼Œæœ€å°æ˜¯16ï¼Œä¹Ÿå°±æ˜¯è¯´length-1çš„æœ«4ä¸ºå…¨1ï¼Œ32å°±æ˜¯æœ«8ä½å…¨1ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ</p>
<blockquote>
<p>å¦‚æœ<code>hashCode(key)</code>çš„å¤§äº<code>length</code>çš„å€¼ï¼Œè€Œä¸”<code>hashCode(key)</code>çš„äºŒè¿›åˆ¶ä½çš„ä½ä½å˜åŒ–ä¸å¤§ï¼Œé‚£ä¹ˆå†²çªå°±ä¼šå¾ˆå¤šï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>Javaä¸­å¯¹è±¡çš„å“ˆå¸Œå€¼éƒ½32ä½æ•´æ•°ï¼Œè€ŒHashMapé»˜è®¤å¤§å°ä¸º16ï¼Œé‚£ä¹ˆæœ‰ä¸¤ä¸ªå¯¹è±¡é‚£ä¹ˆçš„å“ˆå¸Œå€¼åˆ†åˆ«ä¸ºï¼š<code>0xABAB0000</code>ä¸<code>0xBABA0000</code>ï¼Œå®ƒä»¬çš„åå‡ ä½éƒ½æ˜¯ä¸€æ ·ï¼Œé‚£ä¹ˆä¸16å¼‚æˆ–åå¾—åˆ°ç»“æœåº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯äº§ç”Ÿäº†å†²çªã€‚</p>
<p>é€ æˆå†²çªçš„åŸå› å…³é”®åœ¨äº16é™åˆ¶äº†åªèƒ½ç”¨ä½ä½æ¥è®¡ç®—ï¼Œé«˜ä½ç›´æ¥èˆå¼ƒäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é¢å¤–çš„å“ˆå¸Œå‡½æ•°è€Œä¸åªæ˜¯ç®€å•çš„å¯¹è±¡çš„<code>hashCode</code>æ–¹æ³•äº†ã€‚
å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯HashMapä¸­<code>hash</code>å‡½æ•°å¹²çš„äº‹äº†.</p>
</blockquote>
<h3 id="listå¼çš„bucket-node">3. Listå¼çš„bucket Node</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Basic hash bin node, used for most entries.  (See below for</span></span><br><span class="line"><span class="comment">     * TreeNode subclass, and in LinkedHashMap for its Entry subclass.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(<span class="type">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="built_in">this</span>.hash = hash;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span>        &#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span>      &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                    Objects.equals(value, e.getValue()))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>bucketæ˜¯ä¸€ä¸ªlistï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç”¨äºå¼€æ•£åˆ—æ³•è§£å†³å†²çªï¼ˆå¦‚æœå†²çªå°±åœ¨è¿™ä¸ªèŠ‚ç‚¹åé¢é“¾å¼å­˜å‚¨ï¼‰</p>
<p>æ‰€ä»¥æ¯ä¸ªå…ƒç´ æœ‰ä¸€ä¸ªnextèŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªNodeç±»ã€‚</p>
<h3 id="get">4.get</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the value to which the specified key is mapped,</span></span><br><span class="line"><span class="comment">    * or &#123;<span class="doctag">@code</span> null&#125; if this map contains no mapping for the key.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;More formally, if this map contains a mapping from a key</span></span><br><span class="line"><span class="comment">    * k to a value v such that  (key==null ? k==null :</span></span><br><span class="line"><span class="comment">    * key.equals(k)), then this method returns v; otherwise</span></span><br><span class="line"><span class="comment">    * it returns null.  (There can be at most one such mapping.)</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;A return value of null does not &lt;i&gt;necessarily&lt;/i&gt;</span></span><br><span class="line"><span class="comment">    * indicate that the map contains no mapping for the key; it&#x27;s also</span></span><br><span class="line"><span class="comment">    * possible that the map explicitly maps the key to null.</span></span><br><span class="line"><span class="comment">    * The &#123;<span class="doctag">@link</span> #containsKey containsKey&#125; operation may be used to</span></span><br><span class="line"><span class="comment">    * distinguish these two cases.</span></span><br><span class="line"><span class="comment">    * è¿™æ®µè¯æ„æ€å°±æ˜¯è¯´æœ‰çš„keyæ˜¯ç©ºçš„ï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªmapæ²¡æœ‰å»ºç«‹å…³è”çš„å…³ç³»</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #put(Object, Object)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">       Node&lt;K,V&gt; e;</span><br><span class="line">       <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="literal">null</span> ? <span class="literal">null</span> : e.value;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The table, initialized on first use, and resized as necessary. When allocated, 		length is always a power of two. (We also tolerate length zero in some operations to 	 allow bootstrapping mechanics that are currently not needed.)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Implements Map.get and related methods</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> hash hash for key å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key åŸå€¼</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the node, or null if none</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">getNode</span><span class="params">(<span class="type">int</span> hash, Object key)</span> &#123;</span><br><span class="line">       Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="type">int</span> n; K k;</span><br><span class="line">       <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">           (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;    <span class="comment">//æ•°ç»„éç©ºï¼ŒæŠŠæ•°ç»„èµ‹ç»™tabï¼Œé•¿åº¦å¤§äº0ï¼Œè€Œä¸”å¤´ç»“ç‚¹(ç”¨å“ˆå¸Œå€¼å’Œæ•°ç»„é•¿åº¦å¼‚æˆ–)éç©º</span></span><br><span class="line">           <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">               ((k = first.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">               <span class="keyword">return</span> first;		<span class="comment">//çœ‹firstçš„keyæ˜¯å¦ç­‰äºä¼ å…¥çš„key</span></span><br><span class="line">           <span class="keyword">if</span> ((e = first.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)		<span class="comment">//å¦‚æœæ˜¯çº¢é»‘æ ‘æ–¹å¼å­˜å‚¨çš„</span></span><br><span class="line">                   <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);	<span class="comment">//è°ƒç”¨çº¢é»‘æ ‘å¯»æ‰¾treenode</span></span><br><span class="line">               <span class="keyword">do</span> &#123;				<span class="comment">//é“¾å¼å­˜å‚¨çš„è¯é“¾å¼å¯»æ‰¾</span></span><br><span class="line">                   <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                       ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                       <span class="keyword">return</span> e;</span><br><span class="line">               &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;		<span class="comment">//æ‰¾ä¸åˆ°æˆ–è€…é•¿åº¦ä¸ºç©ºä»€ä¹ˆçš„è¿”å›ç©º</span></span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="put">5.put</h3>
<figure>
<img
src="https://ws4.sinaimg.cn/large/006tKfTcgy1fo7ooddqq6j31bo11s7cj.jpg"
alt="hashMap putæ–¹æ³•æ‰§è¡Œæµç¨‹å›¾" />
<figcaption aria-hidden="true">hashMap putæ–¹æ³•æ‰§è¡Œæµç¨‹å›¾</figcaption>
</figure>
<p>â‘ .åˆ¤æ–­é”®å€¼å¯¹æ•°ç»„table[i]æ˜¯å¦ä¸ºç©ºæˆ–ä¸ºnullï¼Œå¦åˆ™æ‰§è¡Œresize()è¿›è¡Œæ‰©å®¹ï¼›</p>
<p>â‘¡.æ ¹æ®é”®å€¼keyè®¡ç®—hashå€¼å¾—åˆ°æ’å…¥çš„æ•°ç»„ç´¢å¼•iï¼Œå¦‚æœtable[i]==nullï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹æ·»åŠ ï¼Œè½¬å‘â‘¥ï¼Œå¦‚æœtable[i]ä¸ä¸ºç©ºï¼Œè½¬å‘â‘¢ï¼›</p>
<p>â‘¢.åˆ¤æ–­table[i]çš„é¦–ä¸ªå…ƒç´ æ˜¯å¦å’Œkeyä¸€æ ·ï¼Œå¦‚æœç›¸åŒç›´æ¥è¦†ç›–valueï¼Œå¦åˆ™è½¬å‘â‘£ï¼Œè¿™é‡Œçš„ç›¸åŒæŒ‡çš„æ˜¯hashCodeä»¥åŠequalsï¼›</p>
<p>â‘£.åˆ¤æ–­table[i] æ˜¯å¦ä¸ºtreeNodeï¼Œå³table[i]
æ˜¯å¦æ˜¯çº¢é»‘æ ‘ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œåˆ™ç›´æ¥åœ¨æ ‘ä¸­æ’å…¥é”®å€¼å¯¹ï¼Œå¦åˆ™è½¬å‘â‘¤ï¼›</p>
<p>â‘¤.éå†table[i]ï¼Œåˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯å¦å¤§äº8ï¼Œå¤§äº8çš„è¯æŠŠé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œåœ¨çº¢é»‘æ ‘ä¸­æ‰§è¡Œæ’å…¥æ“ä½œï¼Œå¦åˆ™è¿›è¡Œé“¾è¡¨çš„æ’å…¥æ“ä½œï¼›éå†è¿‡ç¨‹ä¸­è‹¥å‘ç°keyå·²ç»å­˜åœ¨ç›´æ¥è¦†ç›–valueå³å¯ï¼›</p>
<p>â‘¥.æ’å…¥æˆåŠŸåï¼Œåˆ¤æ–­å®é™…å­˜åœ¨çš„é”®å€¼å¯¹æ•°é‡sizeæ˜¯å¦è¶…å¤šäº†æœ€å¤§å®¹é‡thresholdï¼Œå¦‚æœè¶…è¿‡ï¼Œè¿›è¡Œæ‰©å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Associates the specified value with the specified key in this map.</span></span><br><span class="line"><span class="comment">     * If the map previously contained a mapping for the key, the old</span></span><br><span class="line"><span class="comment">     * value is replaced.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value value to be associated with the specified key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span></span><br><span class="line"><span class="comment">     *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span></span><br><span class="line"><span class="comment">     *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Implements Map.put and related methods</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value the value to put</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> onlyIfAbsent if true, don&#x27;t change existing value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> previous value, or null if none</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">                   <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            n = (tab = resize()).length;	<span class="comment">//å¦‚æœtabä¸ºç©ºï¼Œå…ˆåˆ›å»ºtab</span></span><br><span class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)		<span class="comment">//å¦‚æœtabä¸­å½“å‰hashå€¼ä¸å­˜åœ¨å…ˆåˆ›å»ºè¯¥èŠ‚ç‚¹</span></span><br><span class="line">            tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e; K k;</span><br><span class="line">            <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">                ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))		<span class="comment">//å¯¹äºé“¾è¡¨çš„å¤´èŠ‚ç‚¹æˆ–è€…æ ‘æ ¹ï¼Œå¦‚æœè¯¥keyå­˜åœ¨ï¼Œç›´æ¥è¦†ç›–value</span></span><br><span class="line">                e = p;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)		<span class="comment">//å¦‚æœpæ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œç”¨çº¢é»‘æ ‘çš„æ·»åŠ æ–¹å¼æ·»åŠ </span></span><br><span class="line">                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">            <span class="keyword">else</span> &#123;		<span class="comment">//é“¾è¡¨ï¼Œé¡ºåºæ·»åŠ </span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st //é“¾è¡¨é•¿åº¦å¤§äº8è½¬æ¢ä¸ºçº¢é»‘æ ‘è¿›è¡Œå¤„ç†</span></span><br><span class="line">                            treeifyBin(tab, hash);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))		<span class="comment">//é“¾è¡¨ä¸­å­˜åœ¨è¯¥key</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    p = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)</span><br><span class="line">                    e.value = value;</span><br><span class="line">                afterNodeAccess(e);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        <span class="keyword">if</span> (++size &gt; threshold)		<span class="comment">//è¶…è¿‡æœ€å¤§å®¹é‡ï¼Œæ‰©å®¹</span></span><br><span class="line">            resize();</span><br><span class="line">        afterNodeInsertion(evict);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="resize-æ‰©å®¹">5.resize æ‰©å®¹</h3>
<p>ä½¿ç”¨çš„æ˜¯2æ¬¡å¹‚çš„æ‰©å±•(æŒ‡é•¿åº¦æ‰©ä¸ºåŸæ¥2å€)ï¼Œæ‰€ä»¥ï¼Œå…ƒç´ çš„ä½ç½®è¦ä¹ˆæ˜¯åœ¨åŸä½ç½®ï¼Œè¦ä¹ˆæ˜¯åœ¨åŸä½ç½®å†ç§»åŠ¨2æ¬¡å¹‚çš„ä½ç½®ã€‚çœ‹ä¸‹å›¾å¯ä»¥æ˜ç™½è¿™å¥è¯çš„æ„æ€ï¼Œnä¸ºtableçš„é•¿åº¦ï¼Œå›¾ï¼ˆaï¼‰è¡¨ç¤ºæ‰©å®¹å‰çš„key1å’Œkey2ä¸¤ç§keyç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå›¾ï¼ˆbï¼‰è¡¨ç¤ºæ‰©å®¹åkey1å’Œkey2ä¸¤ç§keyç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå…¶ä¸­<strong>hash1æ˜¯key1å¯¹åº”çš„å“ˆå¸Œä¸é«˜ä½è¿ç®—ç»“æœ</strong>ã€‚</p>
<p><img
src="https://ws3.sinaimg.cn/large/006tKfTcgy1fo7q9z8yzsj319c0ce761.jpg" /></p>
<p>å…ƒç´ åœ¨é‡æ–°è®¡ç®—hashä¹‹åï¼Œå› ä¸ºnå˜ä¸º2å€ï¼Œé‚£ä¹ˆn-1çš„maskèŒƒå›´åœ¨é«˜ä½å¤š1bit(çº¢è‰²)ï¼Œå› æ­¤æ–°çš„indexå°±ä¼šå‘ç”Ÿè¿™æ ·çš„å˜åŒ–ï¼š</p>
<figure>
<img
src="https://ws3.sinaimg.cn/large/006tKfTcly1g0l59m14g8j30k003taao.jpg"
alt="b2cb057773e3d67976c535d6ef547d51_hd" />
<figcaption
aria-hidden="true">b2cb057773e3d67976c535d6ef547d51_hd</figcaption>
</figure>
<p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å……HashMapçš„æ—¶å€™ï¼Œä¸éœ€è¦åƒJDK1.7çš„å®ç°é‚£æ ·é‡æ–°è®¡ç®—hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº†ï¼Œæ˜¯0çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯1çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCapâ€ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º16æ‰©å……ä¸º32çš„resizeç¤ºæ„å›¾ï¼š</p>
<p><img
src="https://ws4.sinaimg.cn/large/006tKfTcly1g0l58u0adjj30k00bjjtk.jpg"
alt="544caeb82a329fa49cc99842818ed1ba_hd" /></u></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initializes or doubles table size.  If null, allocates in</span></span><br><span class="line"><span class="comment">    * accord with initial capacity target held in field threshold.</span></span><br><span class="line"><span class="comment">    * Otherwise, because we are using power-of-two expansion, the</span></span><br><span class="line"><span class="comment">    * elements from each bin must either stay at same index, or move</span></span><br><span class="line"><span class="comment">    * with a power of two offset in the new table.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the table</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">       Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">       <span class="type">int</span> <span class="variable">oldCap</span> <span class="operator">=</span> (oldTab == <span class="literal">null</span>) ? <span class="number">0</span> : oldTab.length; <span class="comment">//æ—§å®¹é‡ï¼Œæ—§Thr(Resizeä¸Šé™)ï¼Œè¶…è¿‡è¿™ä¸ªthresholdå°±è¦å¼€å§‹æ‰©å®¹äº†</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">oldThr</span> <span class="operator">=</span> threshold;</span><br><span class="line">       <span class="type">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;	<span class="comment">//è¶…è¿‡æœ€å¤§å€¼ç›´æ¥æŠŠthresholdç½®ä¸ºintegeræœ€å¤§å€¼ï¼Œä¸å†æ‰©å®¹äº†</span></span><br><span class="line">           <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">               threshold = Integer.MAX_VALUE;</span><br><span class="line">               <span class="keyword">return</span> oldTab;</span><br><span class="line">           &#125;		<span class="comment">//å‘å·¦ç§»ä¸€ä½ï¼Œæ‰©æˆåŸæ¥çš„2å€</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                    oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">               newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">         						<span class="comment">//å¦‚æœoldThresholdåˆå§‹åŒ–äº†ï¼Œé‚£æ–°çš„å®¹é‡åˆå§‹åŒ–ä¸ºthreshold</span></span><br><span class="line">           newCap = oldThr;</span><br><span class="line">       <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaultså¦åˆ™ç”¨é»˜è®¤å€¼åˆå§‹åŒ–</span></span><br><span class="line">           newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">           newThr = (<span class="type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">       &#125;</span><br><span class="line">     <span class="comment">// è®¡ç®—æ–°çš„resizeä¸Šé™newThr</span></span><br><span class="line">       <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)newCap * loadFactor;</span><br><span class="line">           newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                     (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">       &#125;</span><br><span class="line">       threshold = newThr;</span><br><span class="line">       <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">           Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">       table = newTab;	<span class="comment">//åˆå§‹åŒ–æ–°çš„table</span></span><br><span class="line">       <span class="keyword">if</span> (oldTab != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">               Node&lt;K,V&gt; e;</span><br><span class="line">               <span class="keyword">if</span> ((e = oldTab[j]) != <span class="literal">null</span>) &#123;</span><br><span class="line">                   oldTab[j] = <span class="literal">null</span>;</span><br><span class="line">                   <span class="keyword">if</span> (e.next == <span class="literal">null</span>)</span><br><span class="line">                       newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                   <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                       ((TreeNode&lt;K,V&gt;)e).split(<span class="built_in">this</span>, newTab, j, oldCap);</span><br><span class="line">                   <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                       Node&lt;K,V&gt; loHead = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                       Node&lt;K,V&gt; hiHead = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                       Node&lt;K,V&gt; next;</span><br><span class="line">                       <span class="keyword">do</span> &#123;</span><br><span class="line">                           next = e.next;</span><br><span class="line">                           <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123; </span><br><span class="line">                             <span class="comment">//è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ &amp; oldCapï¼Œå›¾ä¸Šç”»çš„æ˜¯è¡¨é•¿-1ï¼Œè¡¨é•¿16çš„æ—¶å€™æ‰©å®¹32åº”è¯¥å’Œ31 &amp;ï¼Œæ˜¯å› ä¸ºè¦åˆ¤æ–­æ˜¯å¦ä¸º0ï¼Œæ¯”å¦‚è¯´5å’Œ21ï¼Œ&amp;31çš„æ—¶å€™æ˜¯ ä¸€ä¸ªæ˜¯5ï¼Œä¸€ä¸ªæ˜¯21ï¼Œä¸å¥½åˆ¤æ–­ï¼Œä½†æ˜¯å¦‚æœ &amp;16ï¼Œ5&amp;16æ˜¯0ï¼Œ21&amp;16æ˜¯ 16ï¼Œè¿™æ ·å°±å¯ä»¥åˆ¤æ–­äº†ã€‚</span></span><br><span class="line">                               <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">                                   loHead = e;</span><br><span class="line">                               <span class="keyword">else</span></span><br><span class="line">                                   loTail.next = e;</span><br><span class="line">                               loTail = e;</span><br><span class="line">                           &#125;			<span class="comment">//å¦‚æœä¸éœ€è¦ç§»ä½ï¼Œæ‰¾ä¸ªé“¾è¡¨loé“¾èµ·æ¥</span></span><br><span class="line">                           <span class="keyword">else</span> &#123;</span><br><span class="line">                               <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">                                   hiHead = e;</span><br><span class="line">                               <span class="keyword">else</span></span><br><span class="line">                                   hiTail.next = e;</span><br><span class="line">                               hiTail = e;</span><br><span class="line">                           &#125;			<span class="comment">//å¦‚æœéœ€è¦ç§»ä½ï¼Œæ‰¾ä¸ªé“¾è¡¨hié“¾èµ·æ¥</span></span><br><span class="line">                       &#125; <span class="keyword">while</span> ((e = next) != <span class="literal">null</span>);</span><br><span class="line">                       <span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                           loTail.next = <span class="literal">null</span>;</span><br><span class="line">                           newTab[j] = loHead;</span><br><span class="line">                       &#125;			<span class="comment">//loè¡¨çš„ä¸åŠ¨</span></span><br><span class="line">                       <span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                           hiTail.next = <span class="literal">null</span>;</span><br><span class="line">                           newTab[j + oldCap] = hiHead;</span><br><span class="line">                       &#125;			<span class="comment">//hiè¡¨çš„æ”¾åœ¨åŠ ä¸Šæ—§è¡¨å®¹é‡çš„ä½ç½®</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> newTab;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   </span><br></pre></td></tr></table></figure>
<h3 id="remove">6.Remove</h3>
<p>Removeçš„æ–¹æ³•æ€è·¯å’Œgetå·®ä¸å¤šï¼Œåªæ˜¯æœ€åæ˜¯--size</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Removes the mapping for the specified key from this map if present.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  key key whose mapping is to be removed from the map</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span></span><br><span class="line"><span class="comment">    *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">    *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span></span><br><span class="line"><span class="comment">    *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">       Node&lt;K,V&gt; e;</span><br><span class="line">       <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">true</span>)) == <span class="literal">null</span> ?</span><br><span class="line">           <span class="literal">null</span> : e.value;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Implements Map.remove and related methods</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> value the value to match if matchValue, else ignored</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> matchValue if true only remove if value is equal</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> movable if false do not move other nodes while removing</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the node, or null if none</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">removeNode</span><span class="params">(<span class="type">int</span> hash, Object key, Object value,</span></span><br><span class="line"><span class="params">                              <span class="type">boolean</span> matchValue, <span class="type">boolean</span> movable)</span> &#123;</span><br><span class="line">       Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, index;</span><br><span class="line">       <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">           (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">           Node&lt;K,V&gt; node = <span class="literal">null</span>, e; K k; V v;</span><br><span class="line">           <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">               ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">               node = p;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                   node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                           ((k = e.key) == key ||</span><br><span class="line">                            (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                           node = e;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       p = e;</span><br><span class="line">                   &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (node != <span class="literal">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                                (value != <span class="literal">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">               <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                   ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="built_in">this</span>, tab, movable);</span><br><span class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                   tab[index] = node.next;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                   p.next = node.next;</span><br><span class="line">               ++modCount;</span><br><span class="line">               --size;</span><br><span class="line">               afterNodeRemoval(node);</span><br><span class="line">               <span class="keyword">return</span> node;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹å®‰å…¨">7.çº¿ç¨‹å®‰å…¨</h3>
<h4 id="java-1.7">Java 1.7</h4>
<p>åœ¨å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸­ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨çš„HashMapï¼Œè€Œä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ConcurrentHashMapã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¯´HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä¸‹é¢ä¸¾ä¾‹å­è¯´æ˜åœ¨å¹¶å‘çš„å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸­ä½¿ç”¨HashMapå¯èƒ½é€ æˆæ­»å¾ªç¯ã€‚ä»£ç ä¾‹å­å¦‚ä¸‹(ä¾¿äºç†è§£ï¼Œä»ç„¶ä½¿ç”¨JDK1.7çš„ç¯å¢ƒ)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMapInfiniteLoop</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;Integer,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer,String&gt;(<span class="number">2</span>ï¼Œ<span class="number">0.75f</span>);  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        map.put(<span class="number">5</span>ï¼Œ <span class="string">&quot;C&quot;</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;Thread1&quot;</span>) &#123;  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">                map.put(<span class="number">7</span>, <span class="string">&quot;B&quot;</span>);  </span><br><span class="line">                System.out.println(map);  </span><br><span class="line">            &#125;;  </span><br><span class="line">        &#125;.start();  </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;Thread2&quot;</span>) &#123;  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">                map.put(<span class="number">3</span>, <span class="string">&quot;A);  </span></span><br><span class="line"><span class="string">                System.out.println(map);  </span></span><br><span class="line"><span class="string">            &#125;;  </span></span><br><span class="line"><span class="string">        &#125;.start();        </span></span><br><span class="line"><span class="string">    &#125;  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œmapåˆå§‹åŒ–ä¸ºä¸€ä¸ªé•¿åº¦ä¸º2çš„æ•°ç»„ï¼ŒloadFactor=0.75ï¼Œthreshold=2*0.75=1ï¼Œä¹Ÿå°±æ˜¯è¯´å½“putç¬¬äºŒä¸ªkeyçš„æ—¶å€™ï¼Œmapå°±éœ€è¦è¿›è¡Œresizeã€‚</p>
<p>é€šè¿‡è®¾ç½®æ–­ç‚¹è®©çº¿ç¨‹1å’Œçº¿ç¨‹2åŒæ—¶debugåˆ°transferæ–¹æ³•(3.3å°èŠ‚ä»£ç å—)çš„é¦–è¡Œã€‚æ³¨æ„æ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹å·²ç»æˆåŠŸæ·»åŠ æ•°æ®ã€‚æ”¾å¼€thread1çš„æ–­ç‚¹è‡³transferæ–¹æ³•çš„â€œEntry
next = e.next;â€
è¿™ä¸€è¡Œï¼›ç„¶åæ”¾å¼€çº¿ç¨‹2çš„çš„æ–­ç‚¹ï¼Œè®©çº¿ç¨‹2è¿›è¡Œresizeã€‚ç»“æœå¦‚ä¸‹å›¾ã€‚ <img
src="https://ws2.sinaimg.cn/large/006tKfTcly1g0l53xl5zbj30k0092757.jpg"
alt="jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾1" /></p>
<p>æ³¨æ„ï¼ŒThread1çš„ e
æŒ‡å‘äº†key(3)ï¼Œè€ŒnextæŒ‡å‘äº†key(7)ï¼Œå…¶åœ¨çº¿ç¨‹äºŒrehashåï¼ŒæŒ‡å‘äº†çº¿ç¨‹äºŒé‡ç»„åçš„é“¾è¡¨ã€‚</p>
<p>çº¿ç¨‹ä¸€è¢«è°ƒåº¦å›æ¥æ‰§è¡Œï¼Œå…ˆæ˜¯æ‰§è¡Œ newTalbe[i] = eï¼Œ ç„¶åæ˜¯e =
nextï¼Œå¯¼è‡´äº†eæŒ‡å‘äº†key(7)ï¼Œè€Œä¸‹ä¸€æ¬¡å¾ªç¯çš„next =
e.nextå¯¼è‡´äº†nextæŒ‡å‘äº†key(3)ã€‚</p>
<figure>
<img
src="https://ws2.sinaimg.cn/large/006tKfTcly1g0l54uk4i4j30k007k0t2.jpg"
alt="jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾2" />
<figcaption aria-hidden="true">jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾2</figcaption>
</figure>
<p>e.next = newTable[i] å¯¼è‡´ key(3).next æŒ‡å‘äº†
key(7)ã€‚æ³¨æ„ï¼šæ­¤æ—¶çš„key(7).next å·²ç»æŒ‡å‘äº†key(3)ï¼Œ
ç¯å½¢é“¾è¡¨å°±è¿™æ ·å‡ºç°äº†ã€‚ <img
src="https://ws4.sinaimg.cn/large/006tKfTcly1g0l57eeta1j30k006zwf4.jpg"
alt="5f3cf5300f041c771a736b40590fd7b1_hd" /></p>
<p>äºæ˜¯ï¼Œå½“æˆ‘ä»¬ç”¨çº¿ç¨‹ä¸€è°ƒç”¨map.get(11)æ—¶ï¼Œæ‚²å‰§å°±å‡ºç°äº†â€”â€”Infinite
Loopã€‚</p>
<h4 id="java1.8">Java1.8</h4>
<p>java1.8åœ¨resizeçš„æ—¶å€™ä¸å†ä½¿ç”¨é‡æ–°è®¡ç®—æ¯ä¸ªHashå€¼çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè€Œä¸”ï¼Œå®ƒæ˜¯æŠŠæ–°å…ƒç´ æ’åœ¨é“¾è¡¨çš„å°¾éƒ¨ï¼Œå°¾éƒ¨çš„nextæŒ‡å‘nullï¼Œé‚£ä¹ˆä¹…ä¸ä¼šå‡ºç°æ‰€è°“æ— çº¿å¾ªç¯ã€‚ä½†ä¾ç„¶æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p>
<p>è¯¦è§ï¼š<em>http://blog.csdn.net/u010412719/article/details/52049347</em></p>
<p>ä½†æ˜¯é™¤äº†Infinite Loopï¼ŒHashMapä¾ç„¶å­˜åœ¨å¦ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p><strong>fail-fast</strong></p>
<p>å¦‚æœåœ¨ä½¿ç”¨è¿­ä»£å™¨çš„è¿‡ç¨‹ä¸­æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†mapï¼Œé‚£ä¹ˆå°†æŠ›å‡ºConcurrentModificationExceptionï¼Œè¿™å°±æ˜¯æ‰€è°“fail-fastç­–ç•¥ã€‚</p>
<p>è¿™ä¸ªå¼‚å¸¸æ„åœ¨æé†’å¼€å‘è€…åŠæ—©æ„è¯†åˆ°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå…·ä½“åŸå› è¯·æŸ¥çœ‹ConcurrentModificationExceptionçš„åŸå› ä»¥åŠè§£å†³æªæ–½</p>
<h3 id="çº¢é»‘æ ‘">8. çº¢é»‘æ ‘</h3>
<p>çº¢é»‘æ ‘éƒ¨åˆ†ç­‰æˆ‘å­¦äº†çº¢é»‘æ ‘å†è¯´å§ã€‚</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/java%E6%BA%90%E7%A0%81/" rel="tag"># javaæºç </a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/02/07/collection_modCount/" rel="prev" title="Java ModCount å’Œçº¿ç¨‹å®‰å…¨ä¹‹é—´çš„å…³ç³»">
                  <i class="fa fa-chevron-left"></i> Java ModCount å’Œçº¿ç¨‹å®‰å…¨ä¹‹é—´çš„å…³ç³»
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/02/08/inner-outer-class/" rel="next" title="å†…éƒ¨ç±»ç”¨æ³•">
                  å†…éƒ¨ç±»ç”¨æ³• <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 â€“ 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nightsnack</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  







  





  


</body>
</html>
